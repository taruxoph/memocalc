<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#f5f0e8">
<title>MemoCalc</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=Nunito:wght@300;400;500;600;700&family=Lora:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --cream: #f5f0e8;
  --cream-dark: #ede7d9;
  --cream-darker: #e3dccf;
  --surface: #faf7f2;
  --surface-raised: #ffffff;
  --text: #2c2416;
  --text-mid: #6b5f4e;
  --text-muted: #a8997f;
  --border: rgba(44,36,22,0.08);
  --shadow-sm: 0 2px 8px rgba(44,36,22,0.06);
  --shadow-md: 0 6px 24px rgba(44,36,22,0.10);
  --shadow-lg: 0 16px 48px rgba(44,36,22,0.14);
  --radius-pill: 999px;
  --radius-card: 20px;
  --radius-sheet: 32px;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
  font-family: 'Nunito', sans-serif;
  background: var(--cream);
  color: var(--text);
  min-height: 100vh;
  overscroll-behavior: none;
  -webkit-font-smoothing: antialiased;
}

/* ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ */
.view { display: none; flex-direction: column; height: 100vh; height: 100dvh; overflow: hidden; }
.view.active { display: flex; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
  padding: 56px 24px 16px;
  background: var(--cream);
  flex-shrink: 0;
}
.header-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.app-title {
  font-family: 'Playfair Display', serif;
  font-size: 34px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -0.5px;
}
.header-subtitle {
  font-size: 13px;
  color: var(--text-muted);
  font-weight: 500;
  margin-top: 2px;
}

/* ‚îÄ‚îÄ BACK NAV ‚îÄ‚îÄ */
.nav-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 52px 20px 12px;
  background: var(--cream);
  flex-shrink: 0;
}
.btn-back {
  display: flex; align-items: center; gap: 6px;
  background: var(--surface-raised);
  border: none; border-radius: var(--radius-pill);
  padding: 8px 16px 8px 12px;
  font-family: 'Nunito', sans-serif;
  font-size: 15px; font-weight: 600;
  color: var(--text-mid);
  cursor: pointer;
  box-shadow: var(--shadow-sm);
  transition: transform 0.15s, box-shadow 0.15s;
}
.btn-back:active { transform: scale(0.95); box-shadow: none; }
.btn-back svg { width: 16px; height: 16px; }

.detail-name {
  font-family: 'Playfair Display', serif;
  font-size: 20px; font-weight: 600;
  max-width: 160px;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.color-badge {
  width: 32px; height: 32px; border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  flex-shrink: 0;
}

/* ‚îÄ‚îÄ LISTS SCROLL ‚îÄ‚îÄ */
.lists-scroll {
  flex: 1; overflow-y: auto;
  padding: 8px 20px 100px;
}
.lists-scroll::-webkit-scrollbar { display: none; }

/* ‚îÄ‚îÄ LIST CARD ‚îÄ‚îÄ */
.list-card {
  background: var(--surface-raised);
  border-radius: var(--radius-card);
  padding: 18px 20px;
  margin-bottom: 12px;
  box-shadow: var(--shadow-sm);
  display: flex; align-items: center; gap: 14px;
  cursor: pointer;
  transition: transform 0.18s cubic-bezier(.34,1.56,.64,1), box-shadow 0.18s;
  position: relative;
  overflow: hidden;
}
.list-card::before {
  content: '';
  position: absolute; left: 0; top: 0; bottom: 0;
  width: 4px;
  background: var(--accent, #ccc);
  border-radius: 4px 0 0 4px;
}
.list-card:active { transform: scale(0.97); box-shadow: var(--shadow-sm); }

.list-card-icon {
  width: 44px; height: 44px; border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
}
.list-card-body { flex: 1; min-width: 0; }
.list-card-name {
  font-size: 16px; font-weight: 700;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.list-card-date { font-size: 12px; color: var(--text-muted); margin-top: 2px; font-weight: 500; }
.list-card-total {
  font-family: 'Nunito', sans-serif;
  font-size: 15px; font-weight: 700;
  flex-shrink: 0;
}
.list-card-chevron { color: var(--text-muted); font-size: 18px; margin-left: 2px; }

.list-card-delete {
  position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
  background: #ff3b30; border: none; border-radius: var(--radius-pill);
  color: white; font-size: 13px; font-weight: 700; padding: 7px 16px;
  cursor: pointer; display: none;
  font-family: 'Nunito', sans-serif;
  box-shadow: 0 4px 12px rgba(255,59,48,0.35);
}
.list-card.deleting .list-card-delete { display: block; }
.list-card.deleting .list-card-chevron { display: none; }

/* ‚îÄ‚îÄ FAB ‚îÄ‚îÄ */
.fab {
  position: fixed; bottom: 32px; right: 24px;
  width: 60px; height: 60px; border-radius: 50%;
  background: var(--text);
  border: none; cursor: pointer;
  font-size: 28px; color: var(--cream);
  box-shadow: var(--shadow-lg);
  display: flex; align-items: center; justify-content: center;
  transition: transform 0.2s cubic-bezier(.34,1.56,.64,1);
  z-index: 100;
}
.fab:active { transform: scale(0.88); }

/* ‚îÄ‚îÄ MENU FAB ‚îÄ‚îÄ */
.menu-fab {
  width: 40px; height: 40px; border-radius: 50%;
  background: var(--surface-raised);
  border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  box-shadow: var(--shadow-sm);
  font-size: 20px;
  transition: transform 0.15s;
}
.menu-fab:active { transform: scale(0.9); }

/* ‚îÄ‚îÄ TABLE HEADER ‚îÄ‚îÄ */
.table-head {
  display: grid;
  grid-template-columns: 1fr 44px 110px;
  padding: 8px 20px 10px;
  background: var(--cream);
  flex-shrink: 0;
}
.table-head span {
  font-size: 11px; font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 1px;
}
.table-head span:last-child { text-align: right; }

/* ‚îÄ‚îÄ ROWS ‚îÄ‚îÄ */
.rows-scroll {
  flex: 1; overflow-y: auto;
  background: var(--cream);
  padding: 0 12px 16px;
}
.rows-scroll::-webkit-scrollbar { display: none; }

.row-card {
  display: grid;
  grid-template-columns: 1fr 44px 110px;
  align-items: center;
  background: var(--surface-raised);
  border-radius: 16px;
  padding: 14px 16px;
  margin-bottom: 8px;
  gap: 8px;
  box-shadow: var(--shadow-sm);
  transition: transform 0.15s;
}
.row-card:active { transform: scale(0.98); }

.row-memo {
  font-size: 14px; font-weight: 600;
  color: var(--text);
  cursor: pointer;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.row-memo-empty { color: var(--text-muted); font-weight: 400; font-style: italic; }

.row-sign-btn {
  width: 34px; height: 34px; border-radius: 50%;
  border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 300;
  transition: transform 0.15s cubic-bezier(.34,1.56,.64,1);
  color: white;
  box-shadow: 0 3px 10px rgba(0,0,0,0.15);
}
.row-sign-btn:active { transform: scale(0.85); }
.row-sign-btn.plus { background: #34c759; }
.row-sign-btn.minus { background: #ff3b30; }

.row-number {
  font-family: 'Lora', serif;
  font-size: 15px; font-weight: 700;
  text-align: right;
  cursor: pointer;
}

/* ‚îÄ‚îÄ ADD ROW BTN ‚îÄ‚îÄ */
.add-row-card {
  display: flex; align-items: center; gap: 12px;
  background: var(--cream-dark);
  border-radius: 16px;
  padding: 14px 16px;
  margin-bottom: 8px;
  cursor: pointer;
  border: 2px dashed var(--cream-darker);
  transition: background 0.15s;
}
.add-row-card:active { background: var(--cream-darker); }
.add-row-card span { font-size: 14px; font-weight: 600; color: var(--text-muted); }

/* ‚îÄ‚îÄ TOTAL BAR ‚îÄ‚îÄ */
.total-bar {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  padding: 20px 24px 36px;
  color: white;
  flex-shrink: 0;
  border-radius: 28px 28px 0 0;
}
.total-label { font-size: 17px; font-weight: 700; }
.total-eq { font-size: 18px; text-align: center; opacity: 0.7; padding: 0 16px; }
.total-value {
  font-family: 'Lora', serif;
  font-size: 26px; font-weight: 700;
  text-align: right;
  letter-spacing: -0.5px;
}

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 10px; padding: 48px;
  color: var(--text-muted);
}
.empty-icon { font-size: 52px; opacity: 0.35; }
.empty-text { font-size: 15px; font-weight: 600; text-align: center; line-height: 1.5; }

/* ‚îÄ‚îÄ MODAL SHEET ‚îÄ‚îÄ */
.sheet-overlay {
  position: fixed; inset: 0;
  background: rgba(20,14,6,0.45);
  display: none; align-items: flex-end; justify-content: center;
  z-index: 200;
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}
.sheet-overlay.open { display: flex; }

.sheet {
  background: var(--surface);
  border-radius: var(--radius-sheet) var(--radius-sheet) 0 0;
  padding: 12px 24px 48px;
  width: 100%;
  max-width: 500px;
  animation: sheetUp 0.3s cubic-bezier(.32,.72,0,1);
}
@keyframes sheetUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.sheet-handle {
  width: 36px; height: 4px;
  background: var(--cream-darker);
  border-radius: 2px;
  margin: 0 auto 24px;
}
.sheet h3 {
  font-family: 'Playfair Display', serif;
  font-size: 22px; font-weight: 600;
  margin-bottom: 20px;
}

/* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
.input-field {
  width: 100%;
  padding: 14px 18px;
  border: 2px solid var(--cream-dark);
  border-radius: 14px;
  font-size: 16px;
  font-family: 'Nunito', sans-serif;
  font-weight: 500;
  margin-bottom: 12px;
  outline: none;
  background: var(--cream);
  color: var(--text);
  transition: border-color 0.2s, box-shadow 0.2s;
}
.input-field:focus {
  border-color: var(--text);
  box-shadow: 0 0 0 4px rgba(44,36,22,0.08);
}

/* ‚îÄ‚îÄ COLOR SWATCHES ‚îÄ‚îÄ */
.color-row {
  display: flex; gap: 10px; flex-wrap: wrap;
  margin-bottom: 20px;
}
.swatch {
  width: 38px; height: 38px; border-radius: 50%;
  cursor: pointer;
  border: 3px solid transparent;
  outline: 3px solid transparent;
  transition: transform 0.15s cubic-bezier(.34,1.56,.64,1), outline-color 0.15s;
  box-shadow: 0 3px 10px rgba(0,0,0,0.15);
}
.swatch.selected {
  outline-color: var(--text);
  outline-offset: 3px;
  transform: scale(1.15);
}

/* ‚îÄ‚îÄ SIGN TOGGLE ‚îÄ‚îÄ */
.sign-row { display: flex; gap: 10px; margin-bottom: 12px; }
.sign-pill {
  flex: 1; padding: 13px;
  border-radius: 14px;
  border: 2px solid var(--cream-dark);
  font-size: 22px; cursor: pointer;
  background: var(--cream);
  transition: all 0.2s cubic-bezier(.34,1.56,.64,1);
  font-family: 'Nunito', sans-serif;
}
.sign-pill.active-plus { background: #34c759; border-color: #34c759; color: white; transform: scale(1.04); }
.sign-pill.active-minus { background: #ff3b30; border-color: #ff3b30; color: white; transform: scale(1.04); }

/* ‚îÄ‚îÄ PRIMARY BUTTON ‚îÄ‚îÄ */
.btn-primary {
  width: 100%; padding: 16px;
  border: none; border-radius: var(--radius-pill);
  font-size: 16px; font-weight: 700;
  font-family: 'Nunito', sans-serif;
  cursor: pointer; color: var(--cream);
  background: var(--text);
  box-shadow: var(--shadow-md);
  transition: transform 0.15s cubic-bezier(.34,1.56,.64,1), opacity 0.15s;
  margin-top: 4px;
}
.btn-primary:active { transform: scale(0.96); opacity: 0.85; }

/* ‚îÄ‚îÄ SECTION LABEL ‚îÄ‚îÄ */
.section-label {
  font-size: 11px; font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 1px;
  margin-bottom: 8px;
  padding: 0 4px;
}

/* ‚îÄ‚îÄ MENU ‚îÄ‚îÄ */
.menu-overlay { position: fixed; inset: 0; display: none; z-index: 149; }
.menu-overlay.open { display: block; }
.menu-panel {
  position: fixed; top: 64px; right: 20px;
  background: var(--surface-raised);
  border-radius: 18px;
  box-shadow: var(--shadow-lg);
  overflow: hidden; display: none; z-index: 150;
  min-width: 190px;
  border: 1px solid var(--border);
}
.menu-panel.open { display: block; animation: menuPop 0.2s cubic-bezier(.34,1.56,.64,1); }
@keyframes menuPop {
  from { transform: scale(0.85) translateY(-8px); opacity: 0; }
  to { transform: scale(1) translateY(0); opacity: 1; }
}
.menu-item {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 18px;
  border: none; background: none;
  font-family: 'Nunito', sans-serif;
  font-size: 15px; font-weight: 600;
  cursor: pointer; width: 100%; text-align: left;
  border-bottom: 1px solid var(--border);
  color: var(--text);
  transition: background 0.1s;
}
.menu-item:last-child { border-bottom: none; }
.menu-item:active { background: var(--cream); }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     VIEW 1 ‚Äî LISTE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="view-lists" class="view active">
  <div class="header">
    <div class="header-row">
      <div>
        <div class="app-title">MemoCalc</div>
        <div class="header-subtitle">Noti»õele tale financiare</div>
      </div>
      <button class="menu-fab" onclick="openMenu()">‚ãØ</button>
    </div>
  </div>

  <div class="lists-scroll" id="lists-container">
    <div class="empty" id="empty-state">
      <div class="empty-icon">üóí</div>
      <div class="empty-text">Nicio listƒÉ √ÆncƒÉ.<br>ApasƒÉ + pentru a √Æncepe.</div>
    </div>
  </div>

  <button class="fab" onclick="openNewListSheet()">+</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     VIEW 2 ‚Äî DETALIU
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="view-detail" class="view">
  <div class="nav-bar">
    <button class="btn-back" onclick="goBack()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      Liste
    </button>
    <div class="detail-name" id="detail-title"></div>
    <div class="color-badge" id="detail-badge"></div>
  </div>

  <div class="table-head">
    <span>memo</span>
    <span></span>
    <span>sumƒÉ</span>
  </div>

  <div class="rows-scroll" id="rows-container"></div>

  <div class="total-bar" id="total-bar">
    <span class="total-label">Total</span>
    <span class="total-eq">=</span>
    <span class="total-value" id="total-value">0</span>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SHEET: LISTƒÇ NOUƒÇ
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="sheet-overlay" id="sheet-new-list" onclick="closeSheet('sheet-new-list',event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h3>ListƒÉ nouƒÉ</h3>
    <div class="section-label">Nume</div>
    <input class="input-field" type="text" id="new-list-name" placeholder="ex: Rata, Vacan»õƒÉ, Proiect..." maxlength="40">
    <div class="section-label">Culoare</div>
    <div class="color-row" id="color-picker"></div>
    <button class="btn-primary" onclick="saveNewList()">CreeazƒÉ lista</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SHEET: R√ÇD NOU / EDITARE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="sheet-overlay" id="sheet-row" onclick="closeSheet('sheet-row',event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <h3 id="sheet-row-title">R√¢nd nou</h3>
    <div class="section-label">Descriere</div>
    <input class="input-field" type="text" id="row-memo" placeholder="ex: 04 oct 2023..." maxlength="40">
    <div class="section-label">Tip</div>
    <div class="sign-row">
      <button class="sign-pill active-plus" id="sign-plus" onclick="setSign('+')">+</button>
      <button class="sign-pill" id="sign-minus" onclick="setSign('-')">‚àí</button>
    </div>
    <div class="section-label">SumƒÉ</div>
    <input class="input-field" type="number" id="row-number" placeholder="0" inputmode="decimal">
    <button class="btn-primary" id="sheet-row-save" onclick="saveRow()">AdaugƒÉ</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MENU
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="menu-overlay" id="menu-overlay" onclick="closeMenu()"></div>
<div class="menu-panel" id="menu-panel">
  <button class="menu-item" onclick="exportData()">üì§ Export JSON</button>
  <button class="menu-item" onclick="importData()">üì• Import JSON</button>
  <input type="file" id="import-input" accept=".json" style="display:none" onchange="handleImport(event)">
</div>

<script>
// ‚îÄ‚îÄ PALETTE ‚îÄ‚îÄ
const COLORS = [
  { hex: '#F5C518', bg: 'rgba(245,197,24,0.15)', emoji: 'üíõ' },
  { hex: '#34c759', bg: 'rgba(52,199,89,0.15)',  emoji: 'üíö' },
  { hex: '#af52de', bg: 'rgba(175,82,222,0.15)', emoji: 'üíú' },
  { hex: '#ff9500', bg: 'rgba(255,149,0,0.15)',  emoji: 'üß°' },
  { hex: '#007aff', bg: 'rgba(0,122,255,0.15)',  emoji: 'üíô' },
  { hex: '#ff3b30', bg: 'rgba(255,59,48,0.15)',  emoji: '‚ù§Ô∏è' },
  { hex: '#00c7be', bg: 'rgba(0,199,190,0.15)',  emoji: 'ü©µ' },
  { hex: '#5856d6', bg: 'rgba(88,86,214,0.15)',  emoji: 'üîµ' },
];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let lists = [];
let currentListId = null;
let editingRowId = null;
let selectedSign = '+';
let selectedColor = COLORS[0];

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ
function save() { localStorage.setItem('memocalc_data', JSON.stringify(lists)); }
function load() { try { const d = localStorage.getItem('memocalc_data'); if (d) lists = JSON.parse(d); } catch(e){} }

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ
load();
buildColorPicker();
renderLists();
registerSW();

function registerSW() {
  if (!('serviceWorker' in navigator)) return;
  const sw = `self.addEventListener('install',e=>{e.waitUntil(caches.open('mc2').then(c=>c.addAll(['./'])))});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))});`;
  const url = URL.createObjectURL(new Blob([sw],{type:'text/javascript'}));
  navigator.serviceWorker.register(url).catch(()=>{});
}

// ‚îÄ‚îÄ COLOR PICKER ‚îÄ‚îÄ
function buildColorPicker() {
  const cp = document.getElementById('color-picker');
  cp.innerHTML = '';
  COLORS.forEach((c, i) => {
    const s = document.createElement('div');
    s.className = 'swatch' + (i===0?' selected':'');
    s.style.background = c.hex;
    s.onclick = () => {
      document.querySelectorAll('.swatch').forEach(x=>x.classList.remove('selected'));
      s.classList.add('selected');
      selectedColor = c;
    };
    cp.appendChild(s);
  });
  selectedColor = COLORS[0];
}

// ‚îÄ‚îÄ LISTS RENDER ‚îÄ‚îÄ
function renderLists() {
  const container = document.getElementById('lists-container');
  const empty = document.getElementById('empty-state');
  container.innerHTML = '';
  if (!lists.length) { container.appendChild(empty); empty.style.display='flex'; return; }

  lists.forEach(list => {
    const total = calcTotal(list);
    const col = COLORS.find(c=>c.hex===list.color) || COLORS[0];
    const el = document.createElement('div');
    el.className = 'list-card';
    el.style.setProperty('--accent', list.color);
    el.innerHTML = `
      <div class="list-card-icon" style="background:${col.bg}">${col.emoji}</div>
      <div class="list-card-body">
        <div class="list-card-name" style="color:${list.color}">${esc(list.name)}</div>
        <div class="list-card-date">${formatDate(list.updatedAt)}</div>
      </div>
      <div class="list-card-total" style="color:${list.color}">${formatNum(total)}</div>
      <div class="list-card-chevron">‚Ä∫</div>
      <button class="list-card-delete" onclick="deleteList(event,'${list.id}')">»òterge</button>
    `;
    el.onclick = () => { if(!el.classList.contains('deleting')) openList(list.id); };
    let pt;
    el.addEventListener('touchstart', () => { pt = setTimeout(() => { document.querySelectorAll('.list-card').forEach(x=>x.classList.remove('deleting')); el.classList.add('deleting'); }, 600); });
    el.addEventListener('touchend', () => clearTimeout(pt));
    el.addEventListener('touchmove', () => clearTimeout(pt));
    container.appendChild(el);
  });
}

function deleteList(e, id) {
  e.stopPropagation();
  if (!confirm('»òtergi lista?')) return;
  lists = lists.filter(l=>l.id!==id);
  save(); renderLists();
}

function calcTotal(list) {
  return (list.rows||[]).reduce((s,r) => s + (r.sign==='+' ? r.number : -r.number), 0);
}

// ‚îÄ‚îÄ NEW LIST ‚îÄ‚îÄ
function openNewListSheet() {
  buildColorPicker();
  document.getElementById('new-list-name').value = '';
  document.getElementById('sheet-new-list').classList.add('open');
  setTimeout(()=>document.getElementById('new-list-name').focus(), 350);
}

function saveNewList() {
  const name = document.getElementById('new-list-name').value.trim();
  if (!name) { shakeInput('new-list-name'); return; }
  const list = { id: uid(), name, color: selectedColor.hex, createdAt: Date.now(), updatedAt: Date.now(), rows: [] };
  lists.unshift(list);
  save(); renderLists();
  document.getElementById('sheet-new-list').classList.remove('open');
  openList(list.id);
}

// ‚îÄ‚îÄ DETAIL ‚îÄ‚îÄ
function openList(id) {
  currentListId = id;
  const list = getList(id);
  const col = COLORS.find(c=>c.hex===list.color)||COLORS[0];
  document.getElementById('detail-title').textContent = list.name;
  document.getElementById('detail-title').style.color = list.color;
  document.getElementById('detail-badge').style.background = list.color;
  document.getElementById('total-bar').style.background = list.color;
  renderRows();
  showView('view-detail');
}

function renderRows() {
  const list = getList(currentListId);
  const container = document.getElementById('rows-container');
  container.innerHTML = '';

  if (!list.rows.length) {
    const em = document.createElement('div');
    em.className = 'empty';
    em.innerHTML = '<div class="empty-icon">‚úèÔ∏è</div><div class="empty-text">Niciun r√¢nd √ÆncƒÉ.<br>ApasƒÉ + pentru a adƒÉuga.</div>';
    container.appendChild(em);
  }

  list.rows.forEach(row => {
    const el = document.createElement('div');
    el.className = 'row-card';
    el.innerHTML = `
      <div class="row-memo ${row.memo?'':'row-memo-empty'}" onclick="editRow('${row.id}')">${row.memo ? esc(row.memo) : 'fƒÉrƒÉ descriere'}</div>
      <button class="row-sign-btn ${row.sign==='+'?'plus':'minus'}" onclick="toggleSign('${row.id}')">
        ${row.sign==='+' ? '+' : '‚àí'}
      </button>
      <div class="row-number" onclick="editRow('${row.id}')" style="color:${list.color}">${formatNum(row.number)}</div>
    `;
    container.appendChild(el);
  });

  // Add row
  const add = document.createElement('div');
  add.className = 'add-row-card';
  add.innerHTML = `<span style="font-size:20px;color:${list.color}">+</span><span>AdaugƒÉ r√¢nd</span>`;
  add.onclick = openNewRowSheet;
  container.appendChild(add);

  updateTotal();
}

function toggleSign(rowId) {
  const list = getList(currentListId);
  const row = list.rows.find(r=>r.id===rowId);
  if (!row) return;
  row.sign = row.sign==='+' ? '-' : '+';
  list.updatedAt = Date.now();
  save(); renderRows();
}

function updateTotal() {
  const list = getList(currentListId);
  document.getElementById('total-value').textContent = formatNum(calcTotal(list));
}

// ‚îÄ‚îÄ ROW SHEET ‚îÄ‚îÄ
function openNewRowSheet() {
  editingRowId = null;
  selectedSign = '+';
  document.getElementById('sheet-row-title').textContent = 'R√¢nd nou';
  document.getElementById('sheet-row-save').textContent = 'AdaugƒÉ';
  document.getElementById('row-memo').value = '';
  document.getElementById('row-number').value = '';
  setSign('+');
  document.getElementById('sheet-row').classList.add('open');
  setTimeout(()=>document.getElementById('row-memo').focus(), 350);
}

function editRow(rowId) {
  const list = getList(currentListId);
  const row = list.rows.find(r=>r.id===rowId);
  if (!row) return;
  editingRowId = rowId;
  selectedSign = row.sign;
  document.getElementById('sheet-row-title').textContent = 'EditeazƒÉ r√¢nd';
  document.getElementById('sheet-row-save').textContent = 'SalveazƒÉ';
  document.getElementById('row-memo').value = row.memo;
  document.getElementById('row-number').value = row.number;
  setSign(row.sign);
  document.getElementById('sheet-row').classList.add('open');
}

function setSign(s) {
  selectedSign = s === '+' ? '+' : '-';
  document.getElementById('sign-plus').className = 'sign-pill' + (s==='+'?' active-plus':'');
  document.getElementById('sign-minus').className = 'sign-pill' + (s!=='+'?' active-minus':'');
}

function saveRow() {
  const memo = document.getElementById('row-memo').value.trim();
  const numRaw = document.getElementById('row-number').value;
  const number = parseFloat(numRaw);
  if (isNaN(number) || numRaw==='') { shakeInput('row-number'); return; }
  const list = getList(currentListId);
  if (editingRowId) {
    const row = list.rows.find(r=>r.id===editingRowId);
    if (row) { row.memo=memo; row.sign=selectedSign; row.number=number; }
  } else {
    list.rows.push({ id: uid(), memo, sign: selectedSign, number });
  }
  list.updatedAt = Date.now();
  save(); renderRows();
  document.getElementById('sheet-row').classList.remove('open');
  editingRowId = null;
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function showView(id) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function goBack() {
  renderLists();
  showView('view-lists');
  currentListId = null;
}

// ‚îÄ‚îÄ MENU ‚îÄ‚îÄ
function openMenu() {
  document.getElementById('menu-overlay').classList.add('open');
  document.getElementById('menu-panel').classList.add('open');
}
function closeMenu() {
  document.getElementById('menu-overlay').classList.remove('open');
  document.getElementById('menu-panel').classList.remove('open');
}

// ‚îÄ‚îÄ EXPORT/IMPORT ‚îÄ‚îÄ
function exportData() {
  closeMenu();
  const blob = new Blob([JSON.stringify(lists,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'memocalc_backup_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
}
function importData() { closeMenu(); document.getElementById('import-input').click(); }
function handleImport(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (!Array.isArray(data)) throw new Error();
      if (confirm('√énlocuie»ôti datele cu backup-ul importat?')) { lists=data; save(); renderLists(); }
    } catch { alert('Fi»ôier invalid.'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

// ‚îÄ‚îÄ SHEET CLOSE ‚îÄ‚îÄ
function closeSheet(id, e) {
  if (e.target.id===id) document.getElementById(id).classList.remove('open');
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function getList(id) { return lists.find(l=>l.id===id); }
function uid() { return Math.random().toString(36).slice(2)+Date.now().toString(36); }
function esc(s) { return s?s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):''; }
function formatNum(n) { return Number(n).toLocaleString('ro-RO',{minimumFractionDigits:0,maximumFractionDigits:2}); }
function formatDate(ts) {
  const d = new Date(ts);
  return d.toLocaleDateString('ro-RO')+', '+d.toLocaleTimeString('ro-RO',{hour:'2-digit',minute:'2-digit'});
}
function shakeInput(id) {
  const el = document.getElementById(id);
  el.style.animation = 'none'; el.offsetHeight;
  el.style.animation = 'shake 0.35s ease';
  el.style.borderColor = '#ff3b30';
  setTimeout(()=>{ el.style.borderColor=''; el.style.animation=''; }, 500);
}

// ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ
document.getElementById('new-list-name').addEventListener('keydown', e=>{if(e.key==='Enter')saveNewList();});
document.getElementById('row-number').addEventListener('keydown', e=>{if(e.key==='Enter')saveRow();});

// ‚îÄ‚îÄ PWA MANIFEST ‚îÄ‚îÄ
const manifest = {name:'MemoCalc',short_name:'MemoCalc',start_url:'.',display:'standalone',background_color:'#f5f0e8',theme_color:'#f5f0e8',icons:[{src:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="22" fill="%232c2416"/><text y=".9em" font-size="72" x="12">üóí</text></svg>',sizes:'192x192',type:'image/svg+xml'}]};
const mblob = new Blob([JSON.stringify(manifest)],{type:'application/json'});
const mlink = document.createElement('link'); mlink.rel='manifest'; mlink.href=URL.createObjectURL(mblob);
document.head.appendChild(mlink);
</script>
<style>
@keyframes shake {
  0%,100%{transform:translateX(0)} 20%{transform:translateX(-6px)} 60%{transform:translateX(6px)} 80%{transform:translateX(-3px)}
}
</style>
</body>
</html>
